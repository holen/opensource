# Distribute
Route 

    shard = hash(routing) % number_of_primary_shards

在主分片和复制分片上成功新建、索引或删除一个文档必要的顺序步骤：

    客户端给Node 1发送新建、索引或删除请求
    节点使用文档的_id确定文档属于分片0。它转发请求到Node 3，分片0位于这个节点上
    Node 3在主分片上执行请求，如果成功，它转发请求到相应的位于Node 1和Node 2的复制节点上
    当所有的复制节点报告成功，Node 3报告成功到请求的节点，请求的节点再报告给客户端

检索文档，在主分片或复制分片上检索一个文档必要的顺序步骤：

    客户端给Node 1发送get请求。
    节点使用文档的_id确定文档属于分片0。分片0对应的复制分片在三个节点上都有。此时，它转发请求到Node 2。
    Node 2返回endangered给Node 1然后返回给客户端。
    对于读请求，为了平衡负载，请求节点会为每个请求选择不同的分片——它会循环所有分片副本

更新文档,执行局部更新必要的顺序步骤：

    客户端给Node 1发送更新请求。
    它转发请求到主分片所在节点Node 3。
    Node 3从主分片检索出文档，修改_source字段的JSON，然后在主分片上重建索引。如果有其他进程修改了文档，它以retry_on_conflict设置的次数重复步骤3，都未成功则放弃。
    如果Node 3成功更新文档，它同时转发文档的新版本到Node 1和Node 2上的复制节点以重建索引。
    当所有复制节点报告成功，Node 3返回成功给请求节点，然后返回给客户端。

通过一个mget请求检索多个文档的顺序步骤：

    客户端向Node 1发送mget请求。
    Node 1为每个分片构建一个多条数据检索请求，然后转发到这些请求所需的主分片或复制分片上。当所有回复被接收，Node 1构建响应并返回给客户端


